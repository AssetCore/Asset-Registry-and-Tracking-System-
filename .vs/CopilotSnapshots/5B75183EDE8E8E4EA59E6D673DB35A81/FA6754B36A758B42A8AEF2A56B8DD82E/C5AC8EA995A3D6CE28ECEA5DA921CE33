using System;
using System.Collections.Generic;
using System.Threading.Tasks;
using AutoMapper;
using MaintenanceScheduler.Application.DTOs;
using MaintenanceScheduler.Domain.Entities;
using MaintenanceScheduler.Domain.Interfaces;

namespace MaintenanceScheduler.Application.Services
{
    public class MaintenanceHistoryService : IMaintenanceHistoryService
    {
        private readonly IUnitOfWork _unitOfWork;
        private readonly IMapper _mapper;

        public MaintenanceHistoryService(IUnitOfWork unitOfWork, IMapper mapper)
        {
            _unitOfWork = unitOfWork ?? throw new ArgumentNullException(nameof(unitOfWork));
            _mapper = mapper ?? throw new ArgumentNullException(nameof(mapper));
        }

        public async Task<ApiResponse<MaintenanceHistoryDto>> GetByIdAsync(Guid id)
        {
            try
            {
                var history = await _unitOfWork.MaintenanceHistories.GetByIdAsync(id);
                if (history == null)
                {
                    return ApiResponse<MaintenanceHistoryDto>.ErrorResponse("Maintenance history not found");
                }

                var dto = _mapper.Map<MaintenanceHistoryDto>(history);
                return ApiResponse<MaintenanceHistoryDto>.SuccessResponse(dto);
            }
            catch (Exception ex)
            {
                return ApiResponse<MaintenanceHistoryDto>.ErrorResponse(
                    "An error occurred while retrieving the maintenance history",
                    new List<string> { ex.Message });
            }
        }

        public async Task<ApiResponse<IEnumerable<MaintenanceHistoryDto>>> GetByAssetIdAsync(Guid assetId)
        {
            try
            {
                var histories = await _unitOfWork.MaintenanceHistories.GetByAssetIdAsync(assetId);
                var dtos = _mapper.Map<IEnumerable<MaintenanceHistoryDto>>(histories);
                return ApiResponse<IEnumerable<MaintenanceHistoryDto>>.SuccessResponse(dtos);
            }
            catch (Exception ex)
            {
                return ApiResponse<IEnumerable<MaintenanceHistoryDto>>.ErrorResponse(
                    "An error occurred while retrieving maintenance histories",
                    new List<string> { ex.Message });
            }
        }

        public async Task<ApiResponse<IEnumerable<MaintenanceHistoryDto>>> GetByDateRangeAsync(
            Guid assetId, DateTime startDate, DateTime endDate)
        {
            try
            {
                var histories = await _unitOfWork.MaintenanceHistories
                    .GetByDateRangeAsync(assetId, startDate, endDate);
                var dtos = _mapper.Map<IEnumerable<MaintenanceHistoryDto>>(histories);
                return ApiResponse<IEnumerable<MaintenanceHistoryDto>>.SuccessResponse(dtos);
            }
            catch (Exception ex)
            {
                return ApiResponse<IEnumerable<MaintenanceHistoryDto>>.ErrorResponse(
                    "An error occurred while retrieving maintenance histories",
                    new List<string> { ex.Message });
            }
        }

        public async Task<ApiResponse<MaintenanceHistoryDto>> CreateAsync(
            CreateMaintenanceHistoryDto dto, string userId)
        {
            try
            {
                var history = _mapper.Map<MaintenanceHistory>(dto);
                history.CreatedBy = userId;

                await _unitOfWork.MaintenanceHistories.AddAsync(history);
                await _unitOfWork.SaveChangesAsync();

                var resultDto = _mapper.Map<MaintenanceHistoryDto>(history);
                return ApiResponse<MaintenanceHistoryDto>.SuccessResponse(
                    resultDto, "Maintenance history created successfully");
            }
            catch (Exception ex)
            {
                return ApiResponse<MaintenanceHistoryDto>.ErrorResponse(
                    "An error occurred while creating the maintenance history",
                    new List<string> { ex.Message });
            }
        }

        public async Task<ApiResponse<bool>> DeleteAsync(Guid id)
        {
            try
            {
                var result = await _unitOfWork.MaintenanceHistories.DeleteAsync(id);
                if (!result)
                {
                    return ApiResponse<bool>.ErrorResponse("Maintenance history not found");
                }

                await _unitOfWork.SaveChangesAsync();
                return ApiResponse<bool>.SuccessResponse(true, "Maintenance history deleted successfully");
            }
            catch (Exception ex)
            {
                return ApiResponse<bool>.ErrorResponse(
                    "An error occurred while deleting the maintenance history",
                    new List<string> { ex.Message });
            }
        }
    }
}