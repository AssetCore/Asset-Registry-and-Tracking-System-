using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AutoMapper;
using MaintenanceScheduler.Application.DTOs;
using MaintenanceScheduler.Domain.Entities;
using MaintenanceScheduler.Domain.Interfaces;

namespace MaintenanceScheduler.Application.Services
{
    public class WarrantyInfoService : IWarrantyInfoService
    {
        private readonly IUnitOfWork _unitOfWork;
        private readonly IMapper _mapper;

        public WarrantyInfoService(IUnitOfWork unitOfWork, IMapper mapper)
        {
            _unitOfWork = unitOfWork ?? throw new ArgumentNullException(nameof(unitOfWork));
            _mapper = mapper ?? throw new ArgumentNullException(nameof(mapper));
        }

        public async Task<ApiResponse<WarrantyInfoDto>> GetByIdAsync(Guid id)
        {
            try
            {
                var warranty = await _unitOfWork.WarrantyInfos.GetByIdAsync(id);
                if (warranty == null)
                {
                    return ApiResponse<WarrantyInfoDto>.ErrorResponse("Warranty information not found");
                }

                var dto = _mapper.Map<WarrantyInfoDto>(warranty);
                dto.DaysUntilExpiry = (warranty.ExpiryDate - DateTime.UtcNow).Days;
                return ApiResponse<WarrantyInfoDto>.SuccessResponse(dto);
            }
            catch (Exception ex)
            {
                return ApiResponse<WarrantyInfoDto>.ErrorResponse(
                    "An error occurred while retrieving warranty information",
                    new List<string> { ex.Message });
            }
        }

        public async Task<ApiResponse<WarrantyInfoDto>> GetByAssetIdAsync(Guid assetId)
        {
            try
            {
                var warranty = await _unitOfWork.WarrantyInfos.GetByAssetIdAsync(assetId);
                if (warranty == null)
                {
                    return ApiResponse<WarrantyInfoDto>.ErrorResponse("Warranty information not found");
                }

                var dto = _mapper.Map<WarrantyInfoDto>(warranty);
                dto.DaysUntilExpiry = (warranty.ExpiryDate - DateTime.UtcNow).Days;
                return ApiResponse<WarrantyInfoDto>.SuccessResponse(dto);
            }
            catch (Exception ex)
            {
                return ApiResponse<WarrantyInfoDto>.ErrorResponse(
                    "An error occurred while retrieving warranty information",
                    new List<string> { ex.Message });
            }
        }

        public async Task<ApiResponse<IEnumerable<WarrantyInfoDto>>> GetExpiringWarrantiesAsync(int days)
        {
            try
            {
                var warranties = await _unitOfWork.WarrantyInfos.GetExpiringWarrantiesAsync(days);
                var dtos = warranties.Select(w =>
                {
                    var dto = _mapper.Map<WarrantyInfoDto>(w);
                    dto.DaysUntilExpiry = (w.ExpiryDate - DateTime.UtcNow).Days;
                    return dto;
                });

                return ApiResponse<IEnumerable<WarrantyInfoDto>>.SuccessResponse(dtos);
            }
            catch (Exception ex)
            {
                return ApiResponse<IEnumerable<WarrantyInfoDto>>.ErrorResponse(
                    "An error occurred while retrieving expiring warranties",
                    new List<string> { ex.Message });
            }
        }

        public async Task<ApiResponse<IEnumerable<WarrantyInfoDto>>> GetActiveWarrantiesAsync()
        {
            try
            {
                var warranties = await _unitOfWork.WarrantyInfos.GetActiveWarrantiesAsync();
                var dtos = warranties.Select(w =>
                {
                    var dto = _mapper.Map<WarrantyInfoDto>(w);
                    dto.DaysUntilExpiry = (w.ExpiryDate - DateTime.UtcNow).Days;
                    return dto;
                });

                return ApiResponse<IEnumerable<WarrantyInfoDto>>.SuccessResponse(dtos);
            }
            catch (Exception ex)
            {
                return ApiResponse<IEnumerable<WarrantyInfoDto>>.ErrorResponse(
                    "An error occurred while retrieving active warranties",
                    new List<string> { ex.Message });
            }
        }

        public async Task<ApiResponse<WarrantyInfoDto>> CreateAsync(
            CreateWarrantyInfoDto dto, string userId)
        {
            try
            {
                var warranty = _mapper.Map<WarrantyInfo>(dto);
                warranty.CreatedBy = userId;
                warranty.IsActive = true;

                await _unitOfWork.WarrantyInfos.AddAsync(warranty);
                await _unitOfWork.SaveChangesAsync();

                var resultDto = _mapper.Map<WarrantyInfoDto>(warranty);
                resultDto.DaysUntilExpiry = (warranty.ExpiryDate - DateTime.UtcNow).Days;

                return ApiResponse<WarrantyInfoDto>.SuccessResponse(
                    resultDto, "Warranty information created successfully");
            }
            catch (Exception ex)
            {
                return ApiResponse<WarrantyInfoDto>.ErrorResponse(
                    "An error occurred while creating warranty information",
                    new List<string> { ex.Message });
            }
        }

        public async Task<ApiResponse<WarrantyInfoDto>> UpdateAsync(
            UpdateWarrantyInfoDto dto, string userId)
        {
            try
            {
                var warranty = await _unitOfWork.WarrantyInfos.GetByIdAsync(dto.Id);
                if (warranty == null)
                {
                    return ApiResponse<WarrantyInfoDto>.ErrorResponse("Warranty information not found");
                }

                warranty.WarrantyProvider = dto.WarrantyProvider;
                warranty.WarrantyType = dto.WarrantyType;
                warranty.ExpiryDate = dto.ExpiryDate;
                warranty.CoverageDetails = dto.CoverageDetails;
                warranty.ContactPerson = dto.ContactPerson;
                warranty.ContactEmail = dto.ContactEmail;
                warranty.ContactPhone = dto.ContactPhone;
                warranty.UpdatedBy = userId;

                await _unitOfWork.WarrantyInfos.UpdateAsync(warranty);
                await _unitOfWork.SaveChangesAsync();

                var resultDto = _mapper.Map<WarrantyInfoDto>(warranty);
                resultDto.DaysUntilExpiry = (warranty.ExpiryDate - DateTime.UtcNow).Days;

                return ApiResponse<WarrantyInfoDto>.SuccessResponse(
                    resultDto, "Warranty information updated successfully");
            }
            catch (Exception ex)
            {
                return ApiResponse<WarrantyInfoDto>.ErrorResponse(
                    "An error occurred while updating warranty information",
                    new List<string> { ex.Message });
            }
        }

        public async Task<ApiResponse<bool>> DeleteAsync(Guid id)
        {
            try
            {
                var result = await _unitOfWork.WarrantyInfos.DeleteAsync(id);
                if (!result)
                {
                    return ApiResponse<bool>.ErrorResponse("Warranty information not found");
                }

                await _unitOfWork.SaveChangesAsync();
                return ApiResponse<bool>.SuccessResponse(true, "Warranty information deleted successfully");
            }
            catch (Exception ex)
            {
                return ApiResponse<bool>.ErrorResponse(
                    "An error occurred while deleting warranty information",
                    new List<string> { ex.Message });
            }
        }
    }
}